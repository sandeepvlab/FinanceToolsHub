<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mortgage Calculator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>üè† Mortgage Calculator</h1>

        <form method="POST" id="mortgage-form">
            <div class="form-group">
                <label><input type="checkbox" checked> ZIP Code:</label>
                <input type="text" id="zipcode" name="zipcode" placeholder="Enter ZIP" required>
            </div>

            <div class="form-group">
                <label><input type="checkbox" checked> Home Value ($):</label>
                <input type="number" id="home_value" name="home_value" placeholder="e.g. 500000" step="0.01" required>
            </div>

            <div class="form-group">
                <label><input type="checkbox" checked> Down Payment:</label>
                <div class="inline-group">
                    <input type="number" id="down_payment" name="down_payment" placeholder="e.g. 20" step="0.01" required>
                    <label><input type="radio" name="down_type" value="$" checked> $</label>
                    <label><input type="radio" name="down_type" value="%"> %</label>
                </div>
            </div>

            <div class="form-group">
                <label><input type="checkbox" checked> Loan Amount ($):</label>
                <input type="number" id="loan_amount" name="loan_amount" placeholder="Auto-calculated" readonly>
            </div>

            <div class="form-group">
                <label><input type="checkbox" checked> Interest Rate (%):</label>
                <input type="text" id="interest_rate" name="interest_rate" placeholder="Auto-fetched" readonly>
            </div>

            <div class="form-group">
                <label><input type="checkbox" checked> Property Tax ($/year):</label>
                <input type="number" id="property_tax" name="property_tax" placeholder="e.g. 3500" step="0.01">
            </div>

            <div class="form-group">
                <label><input type="checkbox" checked> PMI (%):</label>
                <input type="number" id="pmi" name="pmi" placeholder="Auto-adjusted" step="0.01">
            </div>

            <div class="form-group">
                <label><input type="checkbox" checked> Home Insurance ($/year):</label>
                <input type="number" id="home_ins" name="home_ins" placeholder="e.g. 1200" step="0.01">
            </div>

            <div class="form-group">
                <label><input type="checkbox" checked> Monthly HOA ($):</label>
                <input type="number" id="hoa" name="hoa" placeholder="e.g. 200" step="0.01">
            </div>

            <div class="form-group">
                <label><input type="checkbox" checked> Loan Type:</label>
                <select id="loan_type" name="loan_type">
                    <option value="Conventional">Conventional - 30 Years</option>
                    <option value="Conventional15">Conventional - 15 Years</option>
                    <option value="ARM">ARM (5/1)</option>
                </select>
            </div>

            <div class="form-group">
                <label><input type="checkbox" checked> Loan Term (Years):</label>
                <select id="loan_term" name="loan_term">
                    <option value="30">30</option>
                    <option value="20">20</option>
                    <option value="15">15</option>
                    <option value="10">10</option>
                    <option value="5">5</option>
                </select>
            </div>

            <div class="button-group">
                <button type="submit" class="btn-primary">Calculate</button>
                <button type="reset" class="btn-secondary" onclick="clearForm()">Clear</button>
            </div>
        </form>

        {% if result %}
        <div class="result-card">
            <h3>üí∞ Results</h3>
            <p><strong>Loan Amount:</strong> ${{ result.loan_amount }}</p>
            <p><strong>Interest Rate:</strong> {{ result.rate }}%</p>
            <p><strong>Monthly Payment:</strong> ${{ result.monthly_payment }}</p>
        </div>
        {% endif %}
    </div>

<script>
document.querySelectorAll('#zipcode, #loan_type, #loan_term').forEach(el => {
  el.addEventListener('change', async () => {
    const zipcode = document.getElementById('zipcode').value;
    const loan_type = document.getElementById('loan_type').value.includes("ARM") ? "ARM" : "Conventional";
    const loan_term = document.getElementById('loan_term').value;
    if (zipcode.length >= 5) {
      const res = await fetch(`/_rate_hint?zipcode=${zipcode}&loan_type=${loan_type}&loan_term=${loan_term}`);
      const data = await res.json();
      document.getElementById('interest_rate').value = data.rate;
    }
  });
});

// Auto-calc loan amount + PMI logic
document.getElementById("down_payment").addEventListener("input", calcLoan);
document.querySelectorAll('input[name="down_type"]').forEach(r => r.addEventListener("change", calcLoan));
document.getElementById("home_value").addEventListener("input", calcLoan);

function calcLoan() {
    const home = parseFloat(document.getElementById("home_value").value) || 0;
    const down = parseFloat(document.getElementById("down_payment").value) || 0;
    const downType = document.querySelector('input[name="down_type"]:checked').value;
    let downVal = (downType === "%") ? (down / 100) * home : down;
    const loan = home - downVal;
    document.getElementById("loan_amount").value = loan.toFixed(2);

    // PMI rule: <20% down ‚Üí 0.75%, else 0
    const pmi = (downType === "%" && down < 20) ? 0.75 : 0;
    document.getElementById("pmi").value = pmi;
}

function clearForm() {
    document.querySelector('.result-card')?.remove();
}
</script>
</body>
</html>
