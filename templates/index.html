<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Mortgage Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #f9fafb;
      font-family: 'Inter', sans-serif;
      padding: 20px;
    }
    .card {
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .form-label {
      font-weight: 600;
      margin-top: 10px;
    }
    .result-box {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    .input-group-text {
      display: flex;
      gap: 10px;
    }
    .loan-summary h5 {
      font-weight: 600;
      margin-top: 15px;
    }
    .loan-summary p span {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4 text-center">üè† Smart Mortgage Calculator</h1>

    <div class="row">
      <!-- Left side: Inputs -->
      <div class="col-lg-6">
        <div class="card p-4 mb-4">
          <h4>üè¶ Loan Details</h4>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">ZIP Code:</label>
              <input id="zipcode" class="form-control" placeholder="Enter ZIP" onchange="updateRate()" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Home Value ($):</label>
              <input id="home_value" type="number" class="form-control" placeholder="e.g. 500000" />
            </div>

            <div class="col-md-6">
              <label class="form-label">Down Payment:</label>
              <div class="input-group">
                <input id="down_payment" type="number" class="form-control" value="20" />
                <div class="input-group-text">
                  <input type="radio" name="dp_type" value="%" checked> %
                  <input type="radio" name="dp_type" value="$" class="ms-2"> $
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label">Loan Amount ($):</label>
              <input id="loan_amount_field" class="form-control" readonly />
            </div>

            <div class="col-md-6">
              <label class="form-label">Loan Type:</label>
              <select id="loan_type" class="form-select" onchange="updateLoanTerms()">
                <option value="Conventional">Conventional</option>
                <option value="ARM">ARM</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Loan Term (Years):</label>
              <select id="loan_term" class="form-select" onchange="updateRate()">
                <option>30</option>
                <option>20</option>
                <option>15</option>
                <option>10</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Interest Rate (%):</label>
              <input id="interest_rate" class="form-control" readonly />
            </div>

            <div class="col-md-6">
              <label class="form-label">Property Tax ($/year):</label>
              <input id="property_tax" type="number" class="form-control" value="3500" />
            </div>

            <div class="col-md-6">
              <label class="form-label">PMI (%):</label>
              <input id="pmi" type="number" class="form-control" readonly />
            </div>

            <div class="col-md-6">
              <label class="form-label">Home Insurance ($/year):</label>
              <input id="home_ins" class="form-control" readonly />
            </div>

            <div class="col-md-6">
              <label class="form-label">Monthly HOA ($):</label>
              <input id="hoa" type="number" class="form-control" value="200" />
            </div>

            <div class="col-md-6">
              <label class="form-label">Start Date:</label>
              <input type="date" id="start_date" class="form-control" />
            </div>
          </div>

          <div class="mt-4 text-center">
            <button class="btn btn-primary" onclick="calculate()">Calculate</button>
          </div>
        </div>
      </div>

      <!-- Right side: Loan summary + pie chart -->
      <div class="col-lg-6">
        <div class="result-box loan-summary">
          <h4>üí∞ Loan Summary</h4>
          <p><strong>Total Monthly Payment:</strong> $<span id="monthly_payment"></span></p>
          <p><strong>Down Payment Amount:</strong> $<span id="down_amount_summary"></span></p>
          <p><strong>Start Date:</strong> <span id="start_date_summary"></span></p>
          <p><strong>Home Insurance:</strong> $<span id="home_ins_summary"></span></p>
          <p><strong>Yearly Payment Amount:</strong> $<span id="yearly_payment"></span></p>
          <p><strong>Total Loan Payment:</strong> $<span id="total_loan_payment"></span></p>
          <p><strong>Total Principal:</strong> $<span id="total_principal"></span></p>
          <p><strong>Total Interest Payments:</strong> $<span id="total_interest"></span></p>
          <canvas id="chart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    let chart = null;

    // Fill loan terms based on type
    function updateLoanTerms() {
      const type = document.getElementById("loan_type").value;
      const termSelect = document.getElementById("loan_term");
      termSelect.innerHTML = "";
      const options = type === "Conventional" ? [30,20,15,10] : [3,5,7,10];
      options.forEach(y => {
        const opt = document.createElement("option");
        opt.textContent = y;
        termSelect.appendChild(opt);
      });
      updateRate();
    }

    async function updateRate() {
      // Here you should call backend _rate_hint endpoint
      const type = document.getElementById("loan_type").value;
      const term = document.getElementById("loan_term").value;
      const zip = document.getElementById("zipcode").value;
      const res = await fetch(`/_rate_hint?loan_type=${type}&loan_term=${term}&zipcode=${zip}`);
      const data = await res.json();
      document.getElementById("interest_rate").value = data.rate || "";
    }

    async function calculate() {
      const body = {
        zipcode: document.getElementById("zipcode").value,
        home_value: document.getElementById("home_value").value,
        down_payment_value: document.getElementById("down_payment").value,
        down_payment_type: document.querySelector("input[name='dp_type']:checked").value,
        loan_type: document.getElementById("loan_type").value,
        loan_term: document.getElementById("loan_term").value,
        property_tax: document.getElementById("property_tax").value,
        hoa: document.getElementById("hoa").value
      };

      const startDate = document.getElementById("start_date").value;
      const res = await fetch("/calculate", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(body)
      });

      const data = await res.json();

      // Fill input loan amount
      document.getElementById("loan_amount_field").value = data.loan_amount;

      // Loan summary details
      document.getElementById("monthly_payment").textContent = data.monthly_total;
      document.getElementById("down_amount_summary").textContent = data.down_amount;
      document.getElementById("start_date_summary").textContent = startDate || "-";
      document.getElementById("home_ins_summary").textContent = data.home_ins;
      document.getElementById("yearly_payment").textContent = (data.monthly_total*12).toFixed(2);
      document.getElementById("total_loan_payment").textContent = (data.monthly_total*data.loan_term*12).toFixed(2);
      document.getElementById("total_principal").textContent = data.loan_amount;
      document.getElementById("total_interest").textContent = ((data.monthly_total*data.loan_term*12) - data.loan_amount).toFixed(2);

      // Pie chart
      if(chart) chart.destroy();
      chart = new Chart(document.getElementById("chart"), {
        type: 'pie',
        data: {
          labels: ["Principal & Interest", "Property Tax", "Insurance", "PMI", "HOA"],
          datasets: [{
            data: [
              data.monthly_total - (data.home_ins/12 + data.property_tax/12 + data.hoa + data.pmi_percent),
              data.property_tax/12,
              data.home_ins/12,
              data.pmi_percent,
              data.hoa
            ],
            backgroundColor: ["#4e73df", "#1cc88a", "#36b9cc", "#f6c23e", "#e74a3b"]
          }]
        }
      });
    }
  </script>
</body>
</html>
