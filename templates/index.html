<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Smart Mortgage Calculator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <h1>Smart Mortgage Calculator</h1>

        <form method="POST" id="mortgageForm">
            <div class="grid">
                <label>ZIP Code:</label>
                <input type="text" name="zipcode" required>

                <label>Home Value ($):</label>
                <input type="number" name="home_value" min="0" required>

                <label>Down Payment:</label>
                <input type="number" name="down_payment_value" min="0" required>
                <select name="down_payment_type">
                    <option value="$">$</option>
                    <option value="%">%</option>
                </select>

                <label>Loan Type:</label>
                <select name="loan_type" id="loanType" onchange="updateLoanTerm()">
                    <option value="Conventional">Conventional</option>
                    <option value="ARM">ARM</option>
                </select>

                <label>Loan Term:</label>
                <select name="loan_term" id="loanTerm">
                    <option value="30">30-Year</option>
                    <option value="20">20-Year</option>
                    <option value="15">15-Year</option>
                    <option value="10">10-Year</option>
                </select>

                <label>Property Tax ($/yr):</label>
                <input type="number" name="property_tax" min="0" value="3000">

                <label>Home Insurance ($/yr):</label>
                <input type="number" name="home_ins" min="0" value="1500">

                <label>PMI (%):</label>
                <input type="number" step="0.01" name="pmi" min="0" value="0.75" readonly>

                <label>Monthly HOA ($):</label>
                <input type="number" name="hoa" min="0" value="0">

                <button type="submit">Calculate</button>
                <button type="button" onclick="clearForm()">Clear</button>
            </div>
        </form>

        {% if result %}
        <div class="results" id="resultsDiv">
            <h2>Mortgage Summary</h2>
            <p><strong>Loan Amount:</strong> ${{ result.loan_amount }}</p>
            <p><strong>Total Monthly Payment:</strong> ${{ result.monthly_payment }}</p>
            {% if result.pmi_message %}
            <p style="color:red;"><em>{{ result.pmi_message }}</em></p>
            {% endif %}

            <h3>Current Rates for ZIP {{ result.zipcode }}</h3>
            <ul>
                <li>30-Year Fixed: {{ result.rates["30_yr_fixed"] }}%</li>
                <li>20-Year Fixed: {{ result.rates["20_yr_fixed"] }}%</li>
                <li>15-Year Fixed: {{ result.rates["15_yr_fixed"] }}%</li>
                <li>10-Year Fixed: {{ result.rates["10_yr_fixed"] }}%</li>
                <li>ARM 1-Year: {{ result.rates["ARM_1"] }}%</li>
                <li>ARM 3-Year: {{ result.rates["ARM_3"] }}%</li>
                <li>ARM 5-Year: {{ result.rates["ARM_5"] }}%</li>
                <li>ARM 7-Year: {{ result.rates["ARM_7"] }}%</li>
                <li>ARM 10-Year: {{ result.rates["ARM_10"] }}%</li>
            </ul>

            <canvas id="chart"></canvas>

            <script>
                const ctx = document.getElementById('chart');
                const data = {
                    labels: {{ chart_data.keys() | list | tojson }},
                    datasets: [{
                        data: {{ chart_data.values() | list | tojson }},
                        backgroundColor: ['#4e79a7','#f28e2b','#e15759','#76b7b2','#59a14f']
                    }]
                };
                new Chart(ctx, { 
                    type: 'pie', 
                    data: data,
                    options: { responsive: true }
                });

                function updateLoanTerm() {
                    const type = document.getElementById('loanType').value;
                    const termSelect = document.getElementById('loanTerm');
                    termSelect.innerHTML = '';

                    if (type === 'Conventional') {
                        ['30', '20', '15', '10'].forEach(term => {
                            const option = document.createElement('option');
                            option.value = term;
                            option.text = term + '-Year';
                            termSelect.add(option);
                        });
                    } else if (type === 'ARM') {
                        ['1', '3', '5', '7', '10'].forEach(term => {
                            const option = document.createElement('option');
                            option.value = term;
                            option.text = term + '-Year ARM';
                            termSelect.add(option);
                        });
                    }
                }

                function clearForm() {
                    document.getElementById('mortgageForm').reset();
                    document.getElementById('resultsDiv')?.remove();
                }
            </script>
        </div>
        {% endif %}
    </div>
</body>
</html>
