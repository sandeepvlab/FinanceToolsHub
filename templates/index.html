<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mortgage Calculator</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <h1>üè† Mortgage Calculator</h1>

    <form id="calcForm">
      <div class="form-group">
        <label><input type="checkbox" id="zipcodeCheck" checked> Zipcode:</label>
        <input type="text" id="zipcode" placeholder="e.g., 98008" required />
      </div>

      <div class="form-group">
        <label><input type="checkbox" checked> Home Value:</label>
        <div class="input-with-symbol">
          <span>$</span>
          <input type="number" id="homeValue" placeholder="e.g., 800000" required />
        </div>
      </div>

      <div class="form-group">
        <label><input type="checkbox" checked> Down Payment:</label>
        <div class="input-with-symbol">
          <input type="number" id="downPaymentValue" placeholder="e.g., 20" />
          <div class="radio-group">
            <label><input type="radio" name="downType" value="$"> $</label>
            <label><input type="radio" name="downType" value="%" checked> %</label>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label><input type="checkbox" checked> Loan Amount:</label>
        <div class="input-with-symbol">
          <span>$</span>
          <input type="number" id="loanAmount" readonly />
        </div>
      </div>

      <div class="form-group">
        <label><input type="checkbox" checked> Interest Rate:</label>
        <div class="input-with-symbol">
          <input type="number" id="interestRate" readonly />
          <span>%</span>
        </div>
      </div>

      <div class="form-group">
        <label><input type="checkbox" checked> Property Tax:</label>
        <div class="input-with-symbol">
          <span>$</span>
          <input type="number" id="propertyTax" placeholder="e.g., 8000" />
          <span>/year</span>
        </div>
      </div>

      <div class="form-group">
        <label><input type="checkbox" checked> PMI:</label>
        <div class="input-with-symbol">
          <input type="number" id="pmi" placeholder="auto" />
          <span>%</span>
        </div>
      </div>

      <div class="form-group">
        <label><input type="checkbox" checked> Home Insurance:</label>
        <div class="input-with-symbol">
          <span>$</span>
          <input type="number" id="homeIns" placeholder="auto" />
          <span>/year</span>
        </div>
      </div>

      <div class="form-group">
        <label><input type="checkbox" checked> Monthly HOA:</label>
        <div class="input-with-symbol">
          <span>$</span>
          <input type="number" id="hoa" placeholder="e.g., 200" />
        </div>
      </div>

      <div class="form-group">
        <label>Loan Type:</label>
        <select id="loanType">
          <option value="Conventional_30">Conventional - 30 Years</option>
          <option value="Conventional_20">Conventional - 20 Years</option>
          <option value="Conventional_15">Conventional - 15 Years</option>
          <option value="Conventional_10">Conventional - 10 Years</option>
          <option value="ARM_3">ARM - 3 Years</option>
          <option value="ARM_5">ARM - 5 Years</option>
          <option value="ARM_7">ARM - 7 Years</option>
          <option value="ARM_10">ARM - 10 Years</option>
        </select>
      </div>

      <button type="submit">Calculate</button>
    </form>

    <div id="result-section" class="result-section" style="display:none;">
      <h3>Monthly Payment Breakdown</h3>
      <div class="chart-container">
        <canvas id="breakdownChart"></canvas>
      </div>

      <div class="summary-box">
        <p><strong>Loan Amount:</strong> $<span id="loanAmountResult"></span></p>
        <p><strong>Interest Rate:</strong> <span id="interestRateResult"></span>%</p>
        <p><strong>Total Monthly Payment:</strong> $<span id="monthlyTotal"></span></p>
      </div>
    </div>
  </div>

  <script>
    let chartInstance = null;

    async function fetchRate(loanType, loanTerm) {
      const res = await fetch(`/_rate_hint?loan_type=${loanType}&loan_term=${loanTerm}`);
      const data = await res.json();
      return data.rate;
    }

    document.getElementById("calcForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const [loanTypeRaw, termStr] = document.getElementById("loanType").value.split("_");
      const loanType = loanTypeRaw;
      const loanTerm = parseInt(termStr);

      const homeValue = parseFloat(document.getElementById("homeValue").value) || 0;
      const downPaymentValue = parseFloat(document.getElementById("downPaymentValue").value) || 0;
      const downType = document.querySelector('input[name="downType"]:checked').value;
      const zipcode = document.getElementById("zipcode").value.trim();
      const propertyTax = parseFloat(document.getElementById("propertyTax").value) || 0;
      const pmi = document.getElementById("pmi").value;
      const homeIns = document.getElementById("homeIns").value;
      const hoa = parseFloat(document.getElementById("hoa").value) || 0;

      const interestRate = await fetchRate(loanType, loanTerm);
      document.getElementById("interestRate").value = interestRate;

      const payload = {
        zipcode,
        home_value: homeValue,
        down_payment_value: downPaymentValue,
        down_payment_type: downType,
        loan_type: loanType,
        loan_term: loanTerm,
        property_tax: propertyTax,
        pmi,
        home_ins: homeIns,
        hoa
      };

      const response = await fetch("/calculate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const result = await response.json();

      document.getElementById("loanAmount").value = result.loan_amount;
      document.getElementById("loanAmountResult").textContent = result.loan_amount;
      document.getElementById("interestRateResult").textContent = result.interest_rate;
      document.getElementById("monthlyTotal").textContent = result.monthly_total;

      const chartData = result.chart;
      const ctx = document.getElementById("breakdownChart").getContext("2d");
      if (chartInstance) chartInstance.destroy();

      chartInstance = new Chart(ctx, {
        type: "pie",
        data: {
          labels: Object.keys(chartData),
          datasets: [{
            data: Object.values(chartData),
            backgroundColor: ["#4CAF50", "#2196F3", "#FFC107", "#E91E63", "#9C27B0"]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "bottom" }
          }
        }
      });

      document.getElementById("result-section").style.display = "block";
    });
  </script>
</body>
</html>
