<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart Mortgage Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <h2>üè° Smart Mortgage Calculator</h2>

    <div class="main-content">
      <!-- LEFT SIDE: Form -->
      <div class="form-section">
        <div class="form-group">
          <label>Zip Code</label>
          <input type="text" id="zipcode" placeholder="Enter Zipcode">
        </div>

        <div class="form-group">
          <label>Home Value ($)</label>
          <input type="number" id="home_value" placeholder="e.g. 1000000">
        </div>

        <div class="form-group">
          <label>Down Payment</label>
          <div class="input-group">
            <input type="number" id="down_payment_value" placeholder="e.g. 20">
            <select id="down_payment_type">
              <option value="%">%</option>
              <option value="$">$</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>Loan Type</label>
          <select id="loan_type">
            <option value="Conventional">Conventional</option>
            <option value="ARM">ARM</option>
          </select>
        </div>

        <div class="form-group">
          <label>Loan Term (Years)</label>
          <select id="loan_term">
            <option value="30">30 Years</option>
            <option value="20">20 Years</option>
            <option value="15">15 Years</option>
            <option value="10">10 Years</option>
            <option value="7">7 Years (ARM)</option>
            <option value="5">5 Years (ARM)</option>
          </select>
        </div>

        <div class="form-group">
          <label>Property Tax ($/year)</label>
          <input type="number" id="property_tax" placeholder="e.g. 5000">
        </div>

        <div class="form-group">
          <label>Monthly HOA ($)</label>
          <input type="number" id="hoa" placeholder="e.g. 200">
        </div>

        <button id="calculateBtn">Calculate</button>
      </div>

      <!-- RIGHT SIDE: Loan Summary -->
      <div class="summary-section">
        <div class="loan-summary-box">
          <div class="chart-container">
            <canvas id="loanChart"></canvas>
          </div>

          <div class="loan-summary-details">
            <h3>üí∞ Loan Summary</h3>
            <p><strong>Total Monthly Payment:</strong> $<span id="monthly_payment">0</span></p>
            <p><strong>Down Payment Amount:</strong> $<span id="down_payment_amt">0</span></p>
            <p><strong>Start Date:</strong> <span id="start_date"></span></p>
            <p><strong>Home Insurance:</strong> $<span id="home_ins">0</span></p>
            <p><strong>Yearly Payment Amount:</strong> $<span id="yearly_payment">0</span></p>
            <p><strong>Total Loan Payment:</strong> $<span id="total_payment">0</span></p>
            <p><strong>Total Principal:</strong> $<span id="total_principal">0</span></p>
            <p><strong>Total Interest Payments:</strong> $<span id="total_interest">0</span></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let chart;

    document.getElementById("calculateBtn").addEventListener("click", async () => {
      const data = {
        zipcode: document.getElementById("zipcode").value,
        home_value: parseFloat(document.getElementById("home_value").value) || 0,
        down_payment_value: parseFloat(document.getElementById("down_payment_value").value) || 0,
        down_payment_type: document.getElementById("down_payment_type").value,
        loan_type: document.getElementById("loan_type").value,
        loan_term: parseInt(document.getElementById("loan_term").value),
        property_tax: parseFloat(document.getElementById("property_tax").value) || 0,
        hoa: parseFloat(document.getElementById("hoa").value) || 0
      };

      const res = await fetch("/calculate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      const result = await res.json();

      // Safeguards for NaN
      const monthly_payment = result.monthly_payment || 0;
      const loan_amount = result.loan_amount || 0;
      const down_percent = result.down_percent || 0;
      const home_ins = result.home_ins || 0;
      const rate = result.interest_rate || 0;

      const down_amt = (data.down_payment_type === "%")
        ? data.home_value * (data.down_payment_value / 100)
        : data.down_payment_value;

      const total_payment = (monthly_payment * data.loan_term * 12).toFixed(2);
      const total_interest = (total_payment - loan_amount).toFixed(2);

      document.getElementById("monthly_payment").textContent = monthly_payment.toLocaleString();
      document.getElementById("down_payment_amt").textContent = down_amt.toLocaleString();
      document.getElementById("start_date").textContent = new Date().toISOString().split("T")[0];
      document.getElementById("home_ins").textContent = home_ins.toLocaleString();
      document.getElementById("yearly_payment").textContent = (monthly_payment * 12).toFixed(2);
      document.getElementById("total_payment").textContent = total_payment;
      document.getElementById("total_principal").textContent = loan_amount.toLocaleString();
      document.getElementById("total_interest").textContent = total_interest;

      const ctx = document.getElementById("loanChart").getContext("2d");
      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: "pie",
        data: {
          labels: ["Principal", "Interest", "Taxes/HOA/Ins."],
          datasets: [{
            data: [loan_amount, total_interest, (data.property_tax + data.hoa + home_ins)],
            backgroundColor: ["#4e73df", "#1cc88a", "#f6c23e"]
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: "bottom" } }
        }
      });
    });
  </script>
</body>
</html>
