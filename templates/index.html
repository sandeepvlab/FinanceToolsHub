<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Smart Mortgage Calculator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Inline tweaks to enhance layout */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .dp-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radio-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .radio-group label {
            font-weight: normal;
        }

        #zipcode[readonly] {
            background: #f9f9f9;
        }

        .results {
            margin-top: 25px;
        }

        canvas {
            max-width: 100%;
            margin-top: 15px;
        }

        @media (max-width: 700px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Smart Mortgage Calculator</h1>

        <form method="POST" id="mortgageForm">
            <div class="grid-2">

                <!-- ZIP -->
                <div>
                    <label>ZIP Code:</label>
                    <input type="text" id="zipcode" name="zipcode" readonly required>
                </div>

                <!-- Home Value -->
                <div>
                    <label>Home Value ($):</label>
                    <input type="number" name="home_value" id="home_value" min="0" required>
                </div>

                <!-- Down Payment -->
                <div>
                    <label>Down Payment:</label>
                    <div class="dp-group">
                        <input type="number" name="down_payment_value" id="down_payment_value" min="0" value="20" required>
                        <div class="radio-group">
                            <label><input type="radio" name="down_payment_type" value="%" checked> %</label>
                            <label><input type="radio" name="down_payment_type" value="$"> $</label>
                        </div>
                    </div>
                </div>

                <!-- Loan Type -->
                <div>
                    <label>Loan Type:</label>
                    <select name="loan_type" id="loanType" onchange="updateLoanTerm()">
                        <option value="Conventional">Conventional</option>
                        <option value="ARM">ARM</option>
                    </select>
                </div>

                <!-- Loan Term -->
                <div>
                    <label>Loan Term:</label>
                    <select name="loan_term" id="loanTerm">
                        <option value="30">30-Year</option>
                        <option value="20">20-Year</option>
                        <option value="15">15-Year</option>
                        <option value="10">10-Year</option>
                    </select>
                </div>

                <!-- Property Tax -->
                <div>
                    <label>Property Tax ($/yr):</label>
                    <input type="number" name="property_tax" min="0" value="3000">
                </div>

                <!-- Home Insurance -->
                <div>
                    <label>Home Insurance ($/yr):</label>
                    <input type="number" name="home_ins" min="0" value="1500">
                </div>

                <!-- PMI -->
                <div>
                    <label>PMI (%):</label>
                    <input type="number" step="0.01" name="pmi" id="pmi" min="0" value="0.75" readonly>
                </div>

                <!-- HOA -->
                <div>
                    <label>Monthly HOA ($):</label>
                    <input type="number" name="hoa" min="0" value="0">
                </div>
            </div>

            <div style="margin-top: 20px;">
                <button type="submit">Calculate</button>
                <button type="button" onclick="clearForm()">Clear</button>
            </div>
        </form>

        {% if result %}
        <div class="results" id="resultsDiv">
            <h2>Mortgage Summary</h2>
            <p><strong>Loan Amount:</strong> ${{ result.loan_amount }}</p>
            <p><strong>Total Monthly Payment:</strong> ${{ result.monthly_payment }}</p>
            {% if result.pmi_message %}
            <p style="color:red;"><em>{{ result.pmi_message }}</em></p>
            {% endif %}

            <h3>Current Rates for ZIP {{ result.zipcode }}</h3>
            <ul>
                <li>30-Year Fixed: {{ result.rates["30_yr_fixed"] }}%</li>
                <li>20-Year Fixed: {{ result.rates["20_yr_fixed"] }}%</li>
                <li>15-Year Fixed: {{ result.rates["15_yr_fixed"] }}%</li>
                <li>10-Year Fixed: {{ result.rates["10_yr_fixed"] }}%</li>
                <li>ARM 1-Year: {{ result.rates["ARM_1"] }}%</li>
                <li>ARM 3-Year: {{ result.rates["ARM_3"] }}%</li>
                <li>ARM 5-Year: {{ result.rates["ARM_5"] }}%</li>
                <li>ARM 7-Year: {{ result.rates["ARM_7"] }}%</li>
                <li>ARM 10-Year: {{ result.rates["ARM_10"] }}%</li>
            </ul>

            <canvas id="chart"></canvas>
        </div>
        {% endif %}
    </div>

    <script>
        // --- ZIP Auto Fetch ---
        async function getZipFromLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const { latitude, longitude } = pos.coords;
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                    const data = await response.json();
                    const zip = data?.address?.postcode || '';
                    document.getElementById('zipcode').value = zip;
                });
            }
        }

        // --- Update Loan Term Dropdown ---
        function updateLoanTerm() {
            const type = document.getElementById('loanType').value;
            const termSelect = document.getElementById('loanTerm');
            termSelect.innerHTML = '';

            if (type === 'Conventional') {
                ['30', '20', '15', '10'].forEach(term => {
                    const option = document.createElement('option');
                    option.value = term;
                    option.text = term + '-Year';
                    termSelect.add(option);
                });
            } else if (type === 'ARM') {
                ['1', '3', '5', '7', '10'].forEach(term => {
                    const option = document.createElement('option');
                    option.value = term;
                    option.text = term + '-Year ARM';
                    termSelect.add(option);
                });
            }
        }

        // --- Dynamic PMI update ---
        function updatePMI() {
            const hv = parseFloat(document.getElementById('home_value').value) || 0;
            const dpVal = parseFloat(document.getElementById('down_payment_value').value) || 0;
            const dpType = document.querySelector('input[name="down_payment_type"]:checked').value;
            const pmiField = document.getElementById('pmi');

            let dpPercent = dpType === '%' ? dpVal : (dpVal / hv) * 100;

            if (dpPercent >= 20) {
                pmiField.value = 0;
                pmiField.readOnly = true;
            } else {
                pmiField.value = 0.75;
                pmiField.readOnly = true;
            }
        }

        // --- Clear Form ---
        function clearForm() {
            document.getElementById('mortgageForm').reset();
            document.getElementById('resultsDiv')?.remove();
            getZipFromLocation();
        }

        // --- Chart ---
        {% if result %}
        const ctx = document.getElementById('chart');
        const data = {
            labels: {{ chart_data.keys() | list | tojson }},
            datasets: [{
                data: {{ chart_data.values() | list | tojson }},
                backgroundColor: ['#4e79a7','#f28e2b','#e15759','#76b7b2','#59a14f']
            }]
        };
        new Chart(ctx, { type: 'pie', data: data, options: { responsive: true }});
        {% endif %}

        // --- Event Listeners ---
        document.getElementById('down_payment_value').addEventListener('input', updatePMI);
        document.querySelectorAll('input[name="down_payment_type"]').forEach(r => r.addEventListener('change', updatePMI));
        document.getElementById('home_value').addEventListener('input', updatePMI);

        // --- On Load ---
        window.onload = () => {
            getZipFromLocation();
            updatePMI();
        };
    </script>
</body>
</html>
